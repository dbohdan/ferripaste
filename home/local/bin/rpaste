#! /usr/bin/env tclsh

package require base32

source $env(HOME)/.config/rpaste/config.tcl

proc main args {
    global config

    if {[llength $args] < 1 || [llength $args] > 2} {
        puts stderr {usage: rpaste src [.ext]}
        return 1
    }
    lassign $args src ext

    set filename [file tail $src]
    if {$ext ne {} && [regexp {\.} $filename]} {
        set ext .[file extension $filename]
    }
    set rootname [file rootname $filename]
    set id [base32-timestamp [clock seconds]]

    set dest ${rootname}.${id}${ext}
    exec curl \
        --fail \
        --form "file=@$src;filename=$dest" \
        --header "Authorization: $config(token)" \
        --silent \
        $config(url) \
        >@ stdout \
        2>@ stderr \
}

# Suffers from the Y2038 problem.
proc base32-timestamp t {
    string tolower [regsub =*$ [base32::encode [binary format Iu $t]] {}]
}

main {*}$argv
