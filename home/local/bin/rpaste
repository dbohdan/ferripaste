#! /usr/bin/env python3

from __future__ import annotations

import argparse
import re
import subprocess as sp
import sys
import time
import traceback
from pathlib import Path
from typing import Any

import requests
import tomllib

AUTHZ_HEADER = "Authorization"
FORMAT_MAX_BODY_LEN = 200
CONFIG_FILE = Path.home() / ".config/rpaste/config.toml"
TIMEOUT = 30


def main() -> None:
    args = cli()
    conf = config()

    ext = args.ext
    dest = ""
    upload_id = str(int(time.time()))

    if args.file:
        if not ext:
            ext = args.file.suffix

        dest = re.sub(r"[\s%]", "-", args.file.stem)
        if not args.no_id:
            dest = f"{dest}.{upload_id}"
        dest += ext

    headers = {AUTHZ_HEADER: conf["token"]}
    files = {}

    if args.expire_time:
        headers["expire"] = args.expire_time

    try:
        if args.remote_url:
            files["remote"] = args.remote_url
        elif args.url_to_shorten:
            files["url"] = args.url_to_shorten
        else:
            field = "oneshot" if args.one_shot else "file"
            files[field] = (dest, args.file.open("rb"), "application/octet-stream")

        req = requests.Request(
            "POST",
            conf["url"],
            headers=headers,
            files=files,
        )
        prepared = req.prepare()
        if args.verbose:
            print(
                format_request(prepared),
                file=sys.stderr,
            )

        s = requests.Session()
        resp = s.send(
            prepared,
            timeout=TIMEOUT,
        )
        resp.raise_for_status()

        file_url = resp.text.rstrip()
        print(file_url)

        if not args.one_shot:
            with requests.get(file_url, stream=True, timeout=TIMEOUT) as r:
                if r.status_code != requests.codes.ok:
                    print(
                        f"error: URL verification failed (status {r.status_code})",
                        file=sys.stderr,
                    )
                    sys.exit(1)

    except (FileNotFoundError, requests.exceptions.RequestException) as e:
        if args.verbose:
            print(traceback.format_exc(), end="", file=sys.stderr)
        else:
            print(f"error: {e}", file=sys.stderr)

        sys.exit(1)


def cli() -> argparse.Namespace:
    parser = argparse.ArgumentParser()

    parser.add_argument("-1", action="store_true", dest="one_shot", help="one shot")
    parser.add_argument(
        "-e",
        dest="expire_time",
        help="expiration time",
        metavar="TIME",
    )
    parser.add_argument("-I", action="store_true", dest="no_id", help="no id suffix")

    action = parser.add_mutually_exclusive_group(required=True)
    action.add_argument(
        "file",
        help="file to upload",
        nargs=argparse.OPTIONAL,
        type=Path,
    )
    action.add_argument(
        "-r",
        dest="remote_url",
        help="remote source URL",
        metavar="URL",
    )
    action.add_argument(
        "-u",
        dest="url_to_shorten",
        help="URL to shorten",
        metavar="URL",
    )

    parser.add_argument("-v", action="store_true", dest="verbose", help="verbose mode")
    parser.add_argument(
        "-x",
        default="",
        dest="ext",
        help="file extension",
        metavar="EXT",
    )

    return parser.parse_args()


def config() -> dict[str, Any]:
    config = tomllib.loads(CONFIG_FILE.read_text())

    config["token"] = sp.run(
        ["pass", "show", config["pass-name"]],
        capture_output=True,
        check=True,
        text=True,
    ).stdout.rstrip()

    return config


def format_request(prepared: requests.PreparedRequest) -> str:
    headers = (
        f"{header}: {'***' if header == AUTHZ_HEADER else value}"
        for header, value in prepared.headers.items()
    )

    pb = prepared.body
    body = "(empty body)"
    if pb:
        body = str(pb) if len(pb) < FORMAT_MAX_BODY_LEN else f"({len(pb)} byte body)"

    req_info = [
        "Request:",
        prepared.url,
        "",
        *headers,
        "",
        body,
    ]

    return "\n    ".join(req_info)


if __name__ == "__main__":
    main()
